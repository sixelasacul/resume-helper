name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (do not publish)"
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  build:
    name: Build all packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run checks
        run: bun run check

      - name: Build JS bundle
        run: bun run build

      - name: Build platform binaries
        run: bun run build:binary

      - name: Display build output
        run: |
          echo "Build output structure:"
          find dist -type f | head -50

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  publish-platform-packages:
    name: Publish platform packages
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform:
          - resume-helper-darwin-arm64
          - resume-helper-darwin-x64
          - resume-helper-linux-x64
          - resume-helper-linux-arm64
          - resume-helper-windows-x64
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Display package contents
        run: |
          echo "Package: ${{ matrix.platform }}"
          ls -la dist/${{ matrix.platform }}/
          echo ""
          echo "Binary:"
          ls -la dist/${{ matrix.platform }}/bin/
          echo ""
          echo "package.json:"
          cat dist/${{ matrix.platform }}/package.json

      - name: Set executable permissions
        run: chmod -R 755 dist/${{ matrix.platform }}/bin/

      - name: Publish platform package (dry run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        working-directory: dist/${{ matrix.platform }}
        run: npm publish --dry-run

      - name: Publish platform package
        if: ${{ github.event.inputs.dry_run != 'true' && startsWith(github.ref, 'refs/tags/v') }}
        working-directory: dist/${{ matrix.platform }}
        run: npm publish --provenance --access public

  publish-main:
    name: Publish main package
    needs: publish-platform-packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Display package contents
        run: |
          echo "Package files:"
          ls -la
          echo ""
          echo "Bin directory:"
          ls -la bin/
          echo ""
          echo "Dist directory:"
          ls -la dist/

      - name: Publish (dry run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: npm publish --dry-run --ignore-scripts
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish
        if: ${{ github.event.inputs.dry_run != 'true' && startsWith(github.ref, 'refs/tags/v') }}
        run: npm publish --provenance --access public --ignore-scripts
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  create-release:
    name: Create GitHub Release
    needs: [publish-main, publish-platform-packages]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Copy binaries with descriptive names for GitHub release
          for platform in darwin-arm64 darwin-x64 linux-x64 linux-arm64 windows-x64; do
            pkg_dir="dist/resume-helper-${platform}"
            if [ -d "$pkg_dir/bin" ]; then
              if [ "$platform" = "windows-x64" ]; then
                cp "$pkg_dir/bin/resume-helper.exe" "release-assets/resume-helper-${platform}.exe"
              else
                cp "$pkg_dir/bin/resume-helper" "release-assets/resume-helper-${platform}"
              fi
            fi
          done

          echo "Release assets:"
          ls -la release-assets/

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
